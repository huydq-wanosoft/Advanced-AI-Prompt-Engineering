# Automatically label issues based on week and topic
name: Auto Label Learning Issues

on:
  issues:
    types: [opened, edited]
  
permissions:
  issues: write  

jobs:
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Provide PERSONAL_TOKEN to environment
        shell: bash
        run: |
          if [ -z "${{ secrets.PERSONAL_TOKEN }}" ]; then
            echo "PERSONAL_TOKEN secret not found. Create a repo secret named PERSONAL_TOKEN with a PAT that has repo scope." >&2
            exit 1
          fi
          # Persist the PAT to GITHUB_ENV for subsequent steps (do not print the token).
          echo "PERSONAL_TOKEN=${{ secrets.PERSONAL_TOKEN }}" >> $GITHUB_ENV

      - name: Auto label by week
        uses: actions/github-script@v6
        env:
          PERSONAL_TOKEN: ${{ env.PERSONAL_TOKEN }}
        with:
          script: |
            if (!process.env.PERSONAL_TOKEN) {
              throw new Error('PERSONAL_TOKEN not found. Create a repo secret named PERSONAL_TOKEN with a PAT that has repo scope.');
            }
            const octokit = github.getOctokit(process.env.PERSONAL_TOKEN);

            const title = context.payload.issue.title.toLowerCase();
            const labels = [];
            
            // Week detection
            if (title.includes('week 1')) labels.push('week-1');
            if (title.includes('week 2')) labels.push('week-2');
            if (title.includes('week 3')) labels.push('week-3');
            if (title.includes('week 4')) labels.push('week-4');
            if (title.includes('week 5')) labels.push('week-5');
            
            // Topic detection
            if (title.includes('few-shot') || title.includes('zero-shot')) labels.push('few-shot');
            if (title.includes('chain-of-thought') || title.includes('cot')) labels.push('chain-of-thought');
            if (title.includes('role') || title.includes('persona')) labels.push('role-playing');
            if (title.includes('debug')) labels.push('debugging');
            if (title.includes('refactor')) labels.push('refactoring');
            if (title.includes('test')) labels.push('testing');
            if (title.includes('architecture')) labels.push('architecture');
            
            if (labels.length > 0) {
              await octokit.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }


