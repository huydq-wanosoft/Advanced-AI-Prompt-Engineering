# Automatically label issues based on week and topic
name: Auto Label Learning Issues

on:
  issues:
    types: [opened, edited]

# Optional: You can set default permissions for the entire workflow here if needed
# permissions:
#   issues: write

jobs:
  auto-label:
    runs-on: ubuntu-latest
    # CRITICAL: Grant write permission to the default GITHUB_TOKEN for THIS specific job
    permissions:
      issues: write
    steps:
      - name: Auto label by week
        uses: actions/github-script@v6
        # The GITHUB_TOKEN is used automatically by the action.
        # We removed the 'env' block referencing PERSONAL_TOKEN.
        with:
          script: |
            // The 'github' object provided by actions/github-script
            // is already authenticated using the job's GITHUB_TOKEN.
            // const octokit = github.getOctokit(process.env.GITHUB_TOKEN); <-- This line is removed/commented out.

            const title = context.payload.issue.title.toLowerCase();
            const labels = [];

            // Week detection
            if (title.includes('week 1')) labels.push('week-1');
            if (title.includes('week 2')) labels.push('week-2');
            if (title.includes('week 3')) labels.push('week-3');
            if (title.includes('week 4')) labels.push('week-4');
            if (title.includes('week 5')) labels.push('week-5');

            // Topic detection
            if (title.includes('few-shot') || title.includes('zero-shot')) labels.push('few-shot');
            if (title.includes('chain-of-thought') || title.includes('cot')) labels.push('chain-of-thought');
            if (title.includes('role') || title.includes('persona')) labels.push('role-playing');
            if (title.includes('debug')) labels.push('debugging');
            if (title.includes('refactor')) labels.push('refactoring');
            if (title.includes('test')) labels.push('testing');
            if (title.includes('architecture')) labels.push('architecture');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels
              });
            }
